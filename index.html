<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorkShift Manager | –ì—Ä–∞—Ñ–∏–∫ —Å–º–µ–Ω –∏ –∑–∞–¥–∞—á–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-card: #161b22;
            --bg-input: #21262d;
            --bg-hover: #30363d;
            --border: #30363d;
            --text: #c9d1d9;
            --text-muted: #8b949e;
            --accent: #58a6ff;
            --accent-hover: #79c0ff;
            --success: #238636;
            --success-hover: #2ea043;
            --danger: #f85149;
            --danger-hover: #ff7b72;
            --warning: #d29922;
            --custom: #8957e5;
            --day-shift: #238636;
            --night-shift: #f85149;
            --custom-shift: #8957e5;
            --shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            --radius: 12px;
            --transition: all 0.2s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            line-height: 1.6;
            padding: 16px;
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 30%, rgba(88, 166, 255, 0.05) 0%, transparent 50%),
                        radial-gradient(circle at 80% 70%, rgba(137, 87, 229, 0.05) 0%, transparent 50%);
            z-index: -1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background-color: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .header::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--accent), var(--custom));
        }

        .header h1 {
            color: var(--accent);
            font-size: 2.2rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .header p {
            color: var(--text-muted);
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 2rem;
            background-color: var(--bg-card);
            padding: 8px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            flex-wrap: wrap;
            border: 1px solid var(--border);
        }

        .tab-btn {
            flex: 1;
            min-width: 140px;
            background: transparent;
            border: none;
            color: var(--text);
            padding: 14px 20px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: var(--transition);
        }

        .tab-btn:hover {
            background-color: var(--bg-input);
            transform: translateY(-2px);
        }

        .tab-btn.active {
            background-color: var(--bg-input);
            color: var(--accent);
            box-shadow: 0 4px 12px rgba(88, 166, 255, 0.2);
            border: 1px solid var(--accent);
        }

        .tab-btn i {
            font-size: 1.1rem;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background-color: var(--bg-card);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
        }

        .card-title {
            color: var(--accent);
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-title i {
            font-size: 1.3rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            background-color: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2);
        }

        .form-row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .form-row .form-group {
            flex: 1;
            min-width: 200px;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background-color: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--accent-hover);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: var(--success-hover);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: var(--danger-hover);
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-outline:hover {
            background-color: var(--bg-input);
            border-color: var(--accent);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .alert {
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-success {
            background-color: rgba(35, 134, 54, 0.2);
            border: 1px solid var(--success);
            color: #7ee787;
        }

        .alert-danger {
            background-color: rgba(248, 81, 73, 0.2);
            border: 1px solid var(--danger);
            color: #ffa198;
        }

        .alert-warning {
            background-color: rgba(210, 153, 34, 0.2);
            border: 1px solid var(--warning);
            color: #e3b341;
        }

        .alert-info {
            background-color: rgba(88, 166, 255, 0.2);
            border: 1px solid var(--accent);
            color: var(--accent);
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin: 2px;
        }

        .badge-day {
            background-color: var(--day-shift);
            color: white;
        }

        .badge-night {
            background-color: var(--night-shift);
            color: white;
        }

        .badge-custom {
            background-color: var(--custom-shift);
            color: white;
        }

        .badge-success {
            background-color: var(--success);
            color: white;
        }

        .badge-secondary {
            background-color: var(--text-muted);
            color: white;
        }

        .calendar-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 0 -16px;
            padding: 0 16px 20px;
        }

        .calendar-wrapper::-webkit-scrollbar {
            height: 8px;
        }

        .calendar-wrapper::-webkit-scrollbar-track {
            background: var(--bg-input);
            border-radius: 4px;
        }

        .calendar-wrapper::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .calendar-wrapper::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        .calendar {
            background-color: var(--bg-card);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            min-width: 800px;
            border: 1px solid var(--border);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .month-year {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .month-year i {
            font-size: 1.5rem;
        }

        .nav-buttons {
            display: flex;
            gap: 12px;
        }

        .nav-buttons button {
            padding: 12px 20px;
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-weight: bold;
            padding: 14px 0;
            background-color: var(--bg-input);
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .day {
            min-height: 120px;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            gap: 6px;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }

        .day:hover {
            background-color: var(--bg-input);
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        .day.other-month {
            color: var(--text-muted);
            opacity: 0.4;
            cursor: default;
        }

        .day.other-month:hover {
            background-color: transparent;
            transform: none;
            box-shadow: none;
        }

        .day.today {
            border: 2px solid var(--accent);
            font-weight: bold;
            background-color: rgba(88, 166, 255, 0.05);
        }

        .day-number {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 4px;
            align-self: flex-start;
        }

        .shift-info {
            font-size: 0.75rem;
            padding: 5px 8px;
            border-radius: 6px;
            color: white;
            text-align: center;
            font-weight: 600;
            word-break: break-word;
        }

        .shift-day {
            background-color: var(--day-shift);
        }

        .shift-night {
            background-color: var(--night-shift);
        }

        .shift-custom {
            background-color: var(--custom-shift);
        }

        .shift-employee {
            font-size: 0.7rem;
            padding: 4px 6px;
            border-radius: 4px;
            color: white;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 600;
        }

        .task-in-day {
            font-size: 0.7rem;
            background-color: rgba(88, 166, 255, 0.1);
            border-left: 3px solid var(--accent);
            padding: 6px 8px;
            border-radius: 4px;
            word-break: break-word;
            margin-top: 4px;
        }

        .task-report {
            font-size: 0.65rem;
            opacity: 0.9;
            margin-top: 4px;
            color: var(--text-muted);
        }

        .totals {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .total-card {
            background-color: var(--bg-card);
            padding: 24px;
            border-radius: var(--radius);
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .total-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.4);
        }

        .total-label {
            font-size: 1rem;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .big-number {
            font-size: 2.8rem;
            font-weight: bold;
            color: var(--accent);
            margin: 10px 0;
        }

        .total-card .total-label-small {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .employee-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .employee-card {
            background-color: var(--bg-input);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .employee-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .employee-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--accent), var(--custom));
        }

        .employee-name {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--accent);
        }

        .employee-rate {
            font-size: 1.1rem;
            color: var(--text);
            margin-bottom: 16px;
        }

        .employee-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .employee-actions .btn {
            flex: 1;
        }

        .employee-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .employee-dash-card {
            background-color: var(--bg-card);
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .employee-dash-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }

        .employee-dash-name {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--accent);
        }

        .employee-dash-stat {
            font-size: 1.1rem;
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
        }

        .employee-dash-salary {
            font-size: 1.8rem;
            color: var(--accent);
            font-weight: bold;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.2s ease;
        }

        .modal-content {
            background-color: var(--bg-card);
            border-radius: var(--radius);
            padding: 30px;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border);
            position: relative;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 1.8rem;
            color: var(--accent);
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 2rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .close-modal:hover {
            background-color: var(--bg-input);
            color: var(--danger);
        }

        .modal-section {
            margin-bottom: 28px;
        }

        .modal-section h3 {
            color: var(--accent);
            margin-bottom: 16px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-section h3 i {
            font-size: 1.2rem;
        }

        .shift-list, .task-list-modal {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .shift-item, .task-item-modal {
            background-color: var(--bg-input);
            padding: 16px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .no-data {
            color: var(--text-muted);
            font-style: italic;
            text-align: center;
            padding: 30px;
            background-color: var(--bg-input);
            border-radius: 10px;
            border: 1px dashed var(--border);
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin: 24px 0;
            font-size: 0.95rem;
        }

        .color-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-box {
            width: 20px;
            height: 20px;
            border-radius: 6px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
        }

        .task-item {
            background-color: var(--bg-input);
            padding: 18px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .task-item:hover {
            background-color: var(--bg-hover);
        }

        .task-text {
            font-weight: 600;
            font-size: 1.1rem;
            line-height: 1.5;
        }

        .task-report-input {
            background-color: var(--bg-primary);
            border: 1px solid var(--border);
            padding: 12px;
            border-radius: 8px;
            color: var(--text);
            font-family: inherit;
            font-size: 0.95rem;
            resize: vertical;
            min-height: 80px;
            transition: var(--transition);
        }

        .task-report-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }

        .task-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-success {
            background-color: var(--success);
        }

        .notification-error {
            background-color: var(--danger);
        }

        .notification-info {
            background-color: var(--accent);
        }

        @media (max-width: 1200px) {
            .employee-list {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
            
            .employee-dashboard {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }

        @media (max-width: 992px) {
            .calendar {
                min-width: 700px;
            }
            
            .day {
                min-height: 110px;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .form-row .form-group {
                min-width: 100%;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .calendar {
                min-width: 600px;
                padding: 16px;
            }
            
            .day {
                min-height: 100px;
                padding: 8px;
            }
            
            .employee-list {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab-btn {
                min-width: 100%;
            }
            
            .modal-content {
                padding: 20px;
            }
            
            .big-number {
                font-size: 2.2rem;
            }
            
            .month-year {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 576px) {
            body {
                padding: 12px;
            }
            
            .calendar {
                min-width: 500px;
            }
            
            .day {
                min-height: 90px;
            }
            
            .weekdays div {
                font-size: 0.8rem;
            }
            
            .nav-buttons {
                flex-direction: column;
                width: 100%;
            }
            
            .calendar-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .totals {
                grid-template-columns: 1fr;
            }
            
            .employee-dashboard {
                grid-template-columns: 1fr;
            }
        }

        .text-center { text-align: center; }
        .mb-0 { margin-bottom: 0 !important; }
        .mt-0 { margin-top: 0 !important; }
        .mb-20 { margin-bottom: 20px; }
        .mt-20 { margin-top: 20px; }
        .mb-30 { margin-bottom: 30px; }
        .mt-30 { margin-top: 30px; }
        .d-flex { display: flex; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-10 { gap: 10px; }
        .gap-20 { gap: 20px; }
        .w-100 { width: 100%; }
        .hidden { display: none; }
        .cursor-pointer { cursor: pointer; }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-calendar-alt"></i> WorkShift Manager</h1>
            <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–º —Å–º–µ–Ω, –∑–∞–¥–∞—á–∞–º–∏ –∏ —Ä–∞—Å—á—ë—Ç–æ–º –∑–∞—Ä–∞–±–æ—Ç–Ω–æ–π –ø–ª–∞—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('personal')">
                <i class="fas fa-user"></i> –õ–∏—á–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫
            </button>
            <button class="tab-btn" onclick="openTab('general')">
                <i class="fas fa-users"></i> –û–±—â–∏–π –≥—Ä–∞—Ñ–∏–∫
            </button>
            <button class="tab-btn" onclick="openTab('tasks')">
                <i class="fas fa-tasks"></i> –ó–∞–¥–∞—á–∏
            </button>
            <button class="tab-btn" onclick="openTab('settings')">
                <i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>
        </div>

        <!-- –õ–∏—á–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ -->
        <div id="personal" class="tab-content active">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-user-plus"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="newName">–§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</label>
                        <input type="text" id="newName" class="form-control" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="newRate">–°—Ç–∞–≤–∫–∞ (‚ÇΩ/—á–∞—Å)</label>
                        <input type="number" id="newRate" class="form-control" value="500" min="0" step="50">
                    </div>
                    <div class="form-group d-flex align-center" style="align-self: flex-end;">
                        <button class="btn btn-success w-100" onclick="addEmployee()">
                            <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                        </button>
                    </div>
                </div>
                
                <div class="employee-list" id="employeeList">
                    <div class="text-center" style="padding: 40px; color: var(--text-muted);">
                        <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 16px; opacity: 0.5;"></i>
                        <p>–°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title"><i class="fas fa-user-edit"></i> –í—ã–±–æ—Ä —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</h2>
                <div class="form-group">
                    <select id="employeeSelect" class="form-control">
                        <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ‚Äî</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title"><i class="fas fa-calendar-week"></i> –ì—Ä–∞—Ñ–∏–∫ —Å–º–µ–Ω</h2>
                
                <div class="legend">
                    <div class="color-item">
                        <div class="color-box" style="background:var(--day-shift);"></div>
                        <span>–î–Ω–µ–≤–Ω–∞—è —Å–º–µ–Ω–∞ (12 —á)</span>
                    </div>
                    <div class="color-item">
                        <div class="color-box" style="background:var(--night-shift);"></div>
                        <span>–ù–æ—á–Ω–∞—è —Å–º–µ–Ω–∞ (12 —á)</span>
                    </div>
                    <div class="color-item">
                        <div class="color-box" style="background:var(--custom-shift);"></div>
                        <span>–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —á–∞—Å—ã</span>
                    </div>
                </div>

                <div class="calendar-wrapper">
                    <div class="calendar">
                        <div class="calendar-header">
                            <div class="month-year">
                                <i class="fas fa-calendar"></i>
                                <span id="personalMonthYear"></span>
                            </div>
                            <div class="nav-buttons">
                                <button class="btn btn-outline" onclick="prevMonth()">
                                    <i class="fas fa-chevron-left"></i> –ü—Ä–µ–¥—ã–¥—É—â–∏–π
                                </button>
                                <button class="btn btn-outline" onclick="goToToday()">
                                    <i class="fas fa-calendar-day"></i> –°–µ–≥–æ–¥–Ω—è
                                </button>
                                <button class="btn btn-outline" onclick="nextMonth()">
                                    –°–ª–µ–¥—É—é—â–∏–π <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        <div class="weekdays">
                            <div>–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</div>
                            <div>–í—Ç–æ—Ä–Ω–∏–∫</div>
                            <div>–°—Ä–µ–¥–∞</div>
                            <div>–ß–µ—Ç–≤–µ—Ä–≥</div>
                            <div>–ü—è—Ç–Ω–∏—Ü–∞</div>
                            <div>–°—É–±–±–æ—Ç–∞</div>
                            <div>–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</div>
                        </div>
                        <div class="days" id="personalDays"></div>
                    </div>
                </div>
            </div>

            <div class="totals">
                <div class="total-card">
                    <div class="total-label">–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–Ω–µ–π –≤ –º–µ—Å—è—Ü–µ</div>
                    <div class="big-number" id="personalWorkedDays">0</div>
                    <div class="total-label-small">–≤ —Ç–µ–∫—É—â–µ–º –º–µ—Å—è—Ü–µ</div>
                </div>
                <div class="total-card">
                    <div class="total-label">–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ —á–∞—Å–æ–≤</div>
                    <div class="big-number" id="personalTotalHours">0</div>
                    <div class="total-label-small">—á–∞—Å–æ–≤</div>
                </div>
                <div class="total-card">
                    <div class="total-label">–ù–∞—á–∏—Å–ª–µ–Ω–Ω–∞—è –∑–∞—Ä–∞–±–æ—Ç–Ω–∞—è –ø–ª–∞—Ç–∞</div>
                    <div class="big-number" id="personalTotalSalary">0</div>
                    <div class="total-label-small">—Ä—É–±–ª–µ–π</div>
                </div>
            </div>
        </div>

        <!-- –û–±—â–∏–π –≥—Ä–∞—Ñ–∏–∫ -->
        <div id="general" class="tab-content">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-calendar-alt"></i> –û–±—â–∏–π –≥—Ä–∞—Ñ–∏–∫ —Å–º–µ–Ω</h2>
                
                <div id="employeeColors" class="legend"></div>
                
                <div class="legend">
                    <div class="color-item">
                        <div class="color-box" style="background:var(--day-shift);"></div>
                        <span>–î–Ω–µ–≤–Ω–∞—è —Å–º–µ–Ω–∞</span>
                    </div>
                    <div class="color-item">
                        <div class="color-box" style="background:var(--night-shift);"></div>
                        <span>–ù–æ—á–Ω–∞—è —Å–º–µ–Ω–∞</span>
                    </div>
                    <div class="color-item">
                        <div class="color-box" style="background:var(--custom-shift);"></div>
                        <span>–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —á–∞—Å—ã</span>
                    </div>
                </div>

                <div class="calendar-wrapper">
                    <div class="calendar">
                        <div class="calendar-header">
                            <div class="month-year">
                                <i class="fas fa-calendar-alt"></i>
                                <span id="generalMonthYear"></span>
                            </div>
                            <div class="nav-buttons">
                                <button class="btn btn-outline" onclick="prevMonth(true)">
                                    <i class="fas fa-chevron-left"></i> –ü—Ä–µ–¥—ã–¥—É—â–∏–π
                                </button>
                                <button class="btn btn-outline" onclick="goToToday(true)">
                                    <i class="fas fa-calendar-day"></i> –°–µ–≥–æ–¥–Ω—è
                                </button>
                                <button class="btn btn-outline" onclick="nextMonth(true)">
                                    –°–ª–µ–¥—É—é—â–∏–π <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        <div class="weekdays">
                            <div>–ü–Ω</div><div>–í—Ç</div><div>–°—Ä</div><div>–ß—Ç</div><div>–ü—Ç</div><div>–°–±</div><div>–í—Å</div>
                        </div>
                        <div class="days" id="generalDays"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title"><i class="fas fa-chart-bar"></i> –ò—Ç–æ–≥–∏ –∑–∞ –º–µ—Å—è—Ü</h2>
                <div class="employee-dashboard" id="employeeDashboard"></div>
            </div>
        </div>

        <!-- –ó–∞–¥–∞—á–∏ -->
        <div id="tasks" class="tab-content">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-tasks"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="taskEmployee">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
                        <select id="taskEmployee" class="form-control">
                            <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ‚Äî</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="taskDate">–î–∞—Ç–∞</label>
                        <input type="date" id="taskDate" class="form-control">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group" style="flex: 3;">
                        <label class="form-label" for="newTaskText">–¢–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏</label>
                        <input type="text" id="newTaskText" class="form-control" placeholder="–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É –ø–æ–¥—Ä–æ–±–Ω–æ...">
                    </div>
                    <div class="form-group d-flex align-center" style="align-self: flex-end;">
                        <button class="btn btn-success w-100" onclick="addTask()">
                            <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title"><i class="fas fa-list-check"></i> –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á</h2>
                <div class="task-list" id="taskList">
                    <div class="text-center" style="padding: 40px; color: var(--text-muted);">
                        <i class="fas fa-clipboard-list" style="font-size: 3rem; margin-bottom: 16px; opacity: 0.5;"></i>
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏ –¥–∞—Ç—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–¥–∞—á</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div id="settings" class="tab-content">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h2>
                
                <div class="form-group">
                    <label class="form-label">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</label>
                    <div class="d-flex gap-10">
                        <button class="btn btn-outline" onclick="exportData()">
                            <i class="fas fa-file-export"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON
                        </button>
                        <button class="btn btn-outline" onclick="exportToCSV()">
                            <i class="fas fa-file-csv"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</label>
                    <div class="d-flex gap-10">
                        <input type="file" id="importFile" class="form-control" accept=".json,.csv" style="flex: 1;">
                        <button class="btn btn-outline" onclick="importData()">
                            <i class="fas fa-file-import"></i> –ò–º–ø–æ—Ä—Ç
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</label>
                    <div class="d-flex gap-10">
                        <button class="btn btn-outline" onclick="createBackup()">
                            <i class="fas fa-save"></i> –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
                        </button>
                        <button class="btn btn-outline" onclick="restoreBackup()">
                            <i class="fas fa-history"></i> –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö</label>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="clearAllData()">
                        <i class="fas fa-trash-alt"></i> –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</label>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>WorkShift Manager v3.0</strong><br>
                            –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ —Å–º–µ–Ω –∏ –∑–∞–¥–∞—á–∞–º–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.<br>
                            –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è —Å –æ–±–ª–∞–∫–æ–º Firebase.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞ -->
    <div id="dayModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-calendar-day"></i>
                    <span id="modalDateTitle"></span>
                </h2>
                <button class="close-modal" onclick="closeModal()">√ó</button>
            </div>
            
            <div class="modal-section">
                <h3><i class="fas fa-user-clock"></i> –°–º–µ–Ω—ã –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å</h3>
                <div class="shift-list" id="modalShifts"></div>
            </div>
            
            <div class="modal-section">
                <h3><i class="fas fa-tasks"></i> –ó–∞–¥–∞—á–∏ –∏ –æ—Ç—á—ë—Ç—ã</h3>
                <div class="task-list-modal" id="modalTasks"></div>
            </div>
            
            <div class="modal-section">
                <h3><i class="fas fa-chart-pie"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–Ω—è</h3>
                <div id="modalStats"></div>
            </div>
            
            <div class="d-flex justify-center mt-30">
                <button class="btn btn-primary" onclick="closeModal()">
                    <i class="fas fa-times"></i> –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div id="notification" class="notification">
        <i class="fas fa-info-circle"></i>
        <span id="notificationText"></span>
    </div>

    <script>
        // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        const STORAGE_KEYS = {
            EMPLOYEES: 'shiftEmployees_v3',
            SCHEDULES: 'shiftSchedules_v3',
            TASKS: 'shiftTasks_v3',
            BACKUP: 'shiftBackup_v3',
            SETTINGS: 'shiftSettings_v3'
        };

        const DEFAULT_SETTINGS = {
            dayShiftHours: 12,
            nightShiftHours: 12,
            defaultHourlyRate: 500,
            startOfWeek: 1
        };

        const SHIFT_TYPES = {
            DAY: { id: 'day', name: '–î–Ω–µ–≤–Ω–∞—è', hours: 12, color: 'var(--day-shift)', icon: 'fas fa-sun' },
            NIGHT: { id: 'night', name: '–ù–æ—á–Ω–∞—è', hours: 12, color: 'var(--night-shift)', icon: 'fas fa-moon' },
            CUSTOM: { id: 'custom', name: '–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ', color: 'var(--custom-shift)', icon: 'fas fa-user-clock' }
        };

        let employees = {};
        let schedules = {};
        let tasks = {};
        let settings = { ...DEFAULT_SETTINGS };
        let currentDate = new Date();
        let currentEmployeeId = null;
        let employeeColors = [
            '#58a6ff', '#79c0ff', '#d2a8ff', '#ffa8f8', 
            '#f8c73c', '#ff7b72', '#a5ff7b', '#ff8cdc',
            '#56d364', '#ffa657', '#6e7681', '#bc8cff'
        ];

        let db = null;
        let userId = null;
        let tg = null;

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOMContentLoaded - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram
            tg = window.Telegram?.WebApp;
            if (tg) {
                console.log('Telegram Web App –æ–±–Ω–∞—Ä—É–∂–µ–Ω');
                tg.ready();
                tg.expand();
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–º—ã Telegram
                applyTelegramTheme();
                tg.onEvent('themeChanged', applyTelegramTheme);
                
                // –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                tg.MainButton.setText('üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ');
                tg.MainButton.onClick(saveToFirebase);
                tg.MainButton.show();
                
                // –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥
                if (tg.isVersionAtLeast('6.1')) {
                    tg.BackButton.show();
                    tg.BackButton.onClick(() => {
                        if (document.getElementById('dayModal').style.display === 'flex') {
                            closeModal();
                        } else if (window.history.length > 1) {
                            window.history.back();
                        } else {
                            tg.close();
                        }
                    });
                }
                
                // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
                userId = tg.initDataUnsafe?.user?.id?.toString() || 'anonymous';
            } else {
                console.log('Telegram Web App –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω, —Ä–∞–±–æ—Ç–∞–µ–º –≤ –±—Ä–∞—É–∑–µ—Ä–Ω–æ–º —Ä–µ–∂–∏–º–µ');
                userId = localStorage.getItem('workshift_user_id') || `local_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                localStorage.setItem('workshift_user_id', userId);
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
            await initFirebase();
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            await loadData();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            initializeUI();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
            document.getElementById('taskDate').value = formatDate(new Date());
            
            console.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userId);
            showNotification('‚úÖ WorkShift Manager –≥–æ—Ç–æ–≤!', 'success', 3000);
        });

        function applyTelegramTheme() {
            if (!tg) return;
            
            const theme = tg.themeParams;
            if (!theme) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            if (theme.bg_color) {
                document.documentElement.style.setProperty('--bg-primary', theme.bg_color);
                document.body.style.backgroundColor = theme.bg_color;
            }
            if (theme.secondary_bg_color) {
                document.documentElement.style.setProperty('--bg-card', theme.secondary_bg_color);
            }
            if (theme.text_color) {
                document.documentElement.style.setProperty('--text', theme.text_color);
            }
            if (theme.hint_color) {
                document.documentElement.style.setProperty('--text-muted', theme.hint_color);
            }
            if (theme.link_color) {
                document.documentElement.style.setProperty('--accent', theme.link_color);
            }
            if (theme.button_color) {
                document.documentElement.style.setProperty('--accent', theme.button_color);
            }
        }

        async function initFirebase() {
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyBWS0WhhmQ1xOCF1iusA-Wqcd_9lr0iGsU",
                    authDomain: "workshift-manager.firebaseapp.com",
                    projectId: "workshift-manager",
                    storageBucket: "workshift-manager.appspot.com",
                    messagingSenderId: "930769171216",
                    appId: "1:930769171216:web:849d42d2b520682feceb95"
                };
                
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log('Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:', error);
                db = null;
            }
        }

        // ==================== –†–ê–ë–û–¢–ê –° –î–ê–ù–ù–´–ú–ò ====================
        async function saveToFirebase() {
            if (!db) {
                showNotification('‚ùå –û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ', 'error');
                saveToLocalStorage();
                return;
            }
            
            try {
                if (tg) {
                    tg.MainButton.showProgress();
                    tg.MainButton.setText('üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º...');
                }
                
                const dataToSave = {
                    employees,
                    schedules,
                    tasks,
                    settings,
                    lastUpdate: new Date().toISOString(),
                    telegramUser: tg?.initDataUnsafe?.user || null
                };
                
                await db.collection('users').doc(userId).set(dataToSave, { merge: true });
                
                showNotification('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –æ–±–ª–∞–∫–µ', 'success');
                
                if (tg) {
                    tg.HapticFeedback.impactOccurred('light');
                    tg.MainButton.setText('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
                    setTimeout(() => {
                        tg.MainButton.setText('üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ');
                    }, 2000);
                }
                
                // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                saveToLocalStorage();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Firebase:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –æ–±–ª–∞–∫–æ', 'error');
                saveToLocalStorage();
            } finally {
                if (tg) {
                    tg.MainButton.hideProgress();
                }
            }
        }

        async function loadData() {
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ Firebase
            const firebaseLoaded = await loadFromFirebase();
            
            if (!firebaseLoaded) {
                // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage
                loadFromLocalStorage();
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ localStorage, –ø—Ä–æ–±—É–µ–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Ö –≤ Firebase
                if (Object.keys(employees).length > 0 && db) {
                    setTimeout(() => saveToFirebase(), 1000);
                }
            }
            
            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –≤–æ–æ–±—â–µ, —Å–æ–∑–¥–∞–µ–º –¥–µ–º–æ
            if (Object.keys(employees).length === 0) {
                createDemoData();
                saveToLocalStorage();
            }
        }

        async function loadFromFirebase() {
            if (!db) return false;
            
            try {
                const doc = await db.collection('users').doc(userId).get();
                
                if (doc.exists) {
                    const data = doc.data();
                    employees = data.employees || {};
                    schedules = data.schedules || {};
                    tasks = data.tasks || {};
                    settings = { ...DEFAULT_SETTINGS, ...(data.settings || {}) };
                    
                    console.log('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ Firebase');
                    showNotification('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞', 'success');
                    return true;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Firebase:', error);
            }
            
            return false;
        }

        function loadFromLocalStorage() {
            try {
                const employeesData = localStorage.getItem(STORAGE_KEYS.EMPLOYEES);
                const schedulesData = localStorage.getItem(STORAGE_KEYS.SCHEDULES);
                const tasksData = localStorage.getItem(STORAGE_KEYS.TASKS);
                const settingsData = localStorage.getItem(STORAGE_KEYS.SETTINGS);
                
                if (employeesData) employees = JSON.parse(employeesData);
                if (schedulesData) schedules = JSON.parse(schedulesData);
                if (tasksData) tasks = JSON.parse(tasksData);
                if (settingsData) settings = { ...DEFAULT_SETTINGS, ...JSON.parse(settingsData) };
                
                console.log('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ localStorage');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage:', error);
                employees = {};
                schedules = {};
                tasks = {};
                settings = { ...DEFAULT_SETTINGS };
            }
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem(STORAGE_KEYS.EMPLOYEES, JSON.stringify(employees));
                localStorage.setItem(STORAGE_KEYS.SCHEDULES, JSON.stringify(schedules));
                localStorage.setItem(STORAGE_KEYS.TASKS, JSON.stringify(tasks));
                localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(settings));
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', error);
            }
        }

        function scheduleAutoSave() {
            saveToLocalStorage();
            if (db) {
                saveToFirebase();
            }
        }

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ù–¢–ï–†–§–ï–ô–°–ê ====================
        function initializeUI() {
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.getElementById('employeeSelect').addEventListener('change', function(e) {
                currentEmployeeId = e.target.value;
                renderPersonalCalendar();
            });

            document.getElementById('taskEmployee').addEventListener('change', renderTasks);
            document.getElementById('taskDate').addEventListener('change', renderTasks);
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('dayModal');
                if (event.target === modal) {
                    closeModal();
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            updateEmployeeUI();
            updateTaskSelect();
            renderPersonalCalendar();
            renderGeneralCalendar();
            renderEmployeeDashboard();
            renderTasks();
        }

        // ==================== –£–¢–ò–õ–ò–¢–´ ====================
        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.getElementById('notification');
            const text = document.getElementById('notificationText');
            
            if (!notification) {
                console.log(message);
                return;
            }
            
            notification.className = `notification notification-${type}`;
            text.textContent = message;
            notification.classList.add('show');
            
            // –í–∏–±—Ä–∞—Ü–∏—è –≤ Telegram
            if (tg && type === 'success') {
                tg.HapticFeedback.impactOccurred('light');
            }
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('ru-RU', { 
                style: 'currency', 
                currency: 'RUB',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        function getEmployeeNameById(id) {
            return employees[id]?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫';
        }

        function getEmployeeColor(id) {
            return employees[id]?.color || '#6e7681';
        }

        function parseDateString(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        // ==================== –î–ï–ú–û –î–ê–ù–ù–´–ï ====================
        function createDemoData() {
            const demoEmployees = [
                { name: '–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á', rate: 500 },
                { name: '–ü–µ—Ç—Ä–æ–≤–∞ –ê–Ω–Ω–∞ –°–µ—Ä–≥–µ–µ–≤–Ω–∞', rate: 550 },
                { name: '–°–∏–¥–æ—Ä–æ–≤ –ê–ª–µ–∫—Å–µ–π –í–ª–∞–¥–∏–º–∏—Ä–æ–≤–∏—á', rate: 480 }
            ];

            demoEmployees.forEach((demo, index) => {
                const employeeId = generateId();
                employees[employeeId] = {
                    id: employeeId,
                    name: demo.name,
                    rate: demo.rate,
                    color: employeeColors[index % employeeColors.length],
                    createdAt: Date.now()
                };
                schedules[employeeId] = {};
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–º–æ-—Å–º–µ–Ω—ã
            const today = new Date();
            const employeeIds = Object.keys(employees);
            
            for (let i = 0; i < 10; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dateStr = formatDate(date);
                
                employeeIds.forEach(employeeId => {
                    if (Math.random() > 0.5) {
                        const shiftType = Math.random() > 0.5 ? 'day' : 'night';
                        schedules[employeeId][dateStr] = {
                            hours: shiftType === 'day' ? 12 : 12,
                            type: shiftType,
                            notes: '',
                            createdAt: Date.now()
                        };
                    }
                });
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–º–æ-–∑–∞–¥–∞—á–∏
            employeeIds.forEach(employeeId => {
                const dateStr = formatDate(today);
                const taskKey = `${employeeId}:${dateStr}`;
                tasks[taskKey] = [
                    {
                        text: '–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –æ—Ç—á—ë—Ç –∑–∞ –Ω–µ–¥–µ–ª—é',
                        report: '–û—Ç—á—ë—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—é',
                        completed: true,
                        createdAt: Date.now() - 86400000
                    },
                    {
                        text: '–ü—Ä–æ–≤–µ—Å—Ç–∏ —Å–æ–±—Ä–∞–Ω–∏–µ –æ—Ç–¥–µ–ª–∞',
                        report: '',
                        completed: false,
                        createdAt: Date.now()
                    }
                ];
            });

            console.log('–î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ —Å–æ–∑–¥–∞–Ω—ã');
        }

        // ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–û–¢–†–£–î–ù–ò–ö–ê–ú–ò ====================
        function addEmployee() {
            const nameInput = document.getElementById('newName');
            const rateInput = document.getElementById('newRate');
            
            const name = nameInput.value.trim();
            const rate = parseInt(rateInput.value) || settings.defaultHourlyRate;
            
            if (!name) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞', 'error');
                nameInput.focus();
                return;
            }
            
            if (name.length < 3) {
                showNotification('–§–ò–û –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç
            const isDuplicate = Object.values(employees).some(emp => 
                emp.name.toLowerCase() === name.toLowerCase()
            );
            
            if (isDuplicate) {
                showNotification('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å —Ç–∞–∫–∏–º –§–ò–û —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error');
                return;
            }
            
            const employeeId = generateId();
            employees[employeeId] = {
                id: employeeId,
                name: name,
                rate: rate,
                color: employeeColors[Object.keys(employees).length % employeeColors.length],
                createdAt: Date.now()
            };
            
            schedules[employeeId] = {};
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            scheduleAutoSave();
            updateEmployeeUI();
            updateTaskSelect();
            
            // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            nameInput.value = '';
            rateInput.value = settings.defaultHourlyRate;
            nameInput.focus();
            
            showNotification(`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ "${name}" –¥–æ–±–∞–≤–ª–µ–Ω`, 'success');
        }

        function updateEmployeeUI() {
            const select = document.getElementById('employeeSelect');
            const list = document.getElementById('employeeList');
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
            select.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ‚Äî</option>';
            
            Object.values(employees).sort((a, b) => a.name.localeCompare(b.name)).forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = `${employee.name} (${employee.rate} ‚ÇΩ/—á)`;
                select.appendChild(option);
            });
            
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            if (currentEmployeeId && employees[currentEmployeeId]) {
                select.value = currentEmployeeId;
            } else if (Object.keys(employees).length > 0) {
                currentEmployeeId = Object.keys(employees)[0];
                select.value = currentEmployeeId;
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
            list.innerHTML = '';
            
            if (Object.keys(employees).length === 0) {
                list.innerHTML = `
                    <div class="text-center" style="padding: 40px; color: var(--text-muted); grid-column: 1/-1;">
                        <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 16px; opacity: 0.5;"></i>
                        <p>–°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.</p>
                    </div>
                `;
                return;
            }
            
            Object.values(employees).sort((a, b) => a.name.localeCompare(b.name)).forEach(employee => {
                const card = document.createElement('div');
                card.className = 'employee-card';
                card.innerHTML = `
                    <div class="employee-name">${employee.name}</div>
                    <div class="employee-rate">${employee.rate} ‚ÇΩ/—á</div>
                    <div class="d-flex align-center gap-10 mb-20">
                        <div class="color-box" style="background:${employee.color};"></div>
                        <span style="font-size: 0.9rem; color: var(--text-muted);">–¶–≤–µ—Ç –≤ –≥—Ä–∞—Ñ–∏–∫–µ</span>
                    </div>
                    <div class="employee-actions">
                        <button class="btn btn-outline btn-sm" onclick="editEmployee('${employee.id}')">
                            <i class="fas fa-edit"></i> –ò–∑–º–µ–Ω–∏—Ç—å
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteEmployee('${employee.id}')">
                            <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function editEmployee(employeeId) {
            const employee = employees[employeeId];
            if (!employee) return;
            
            const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:', employee.name);
            if (!newName || newName.trim() === '') return;
            
            const newRate = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—Ç–∞–≤–∫—É (‚ÇΩ/—á):', employee.rate);
            if (!newRate) return;
            
            const rate = parseInt(newRate);
            if (isNaN(rate) || rate < 0) {
                showNotification('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞', 'error');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç
            const isDuplicate = Object.values(employees).some(emp => 
                emp.id !== employeeId && emp.name.toLowerCase() === newName.toLowerCase()
            );
            
            if (isDuplicate) {
                showNotification('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å —Ç–∞–∫–∏–º –§–ò–û —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error');
                return;
            }
            
            employee.name = newName.trim();
            employee.rate = rate;
            
            scheduleAutoSave();
            updateEmployeeUI();
            updateTaskSelect();
            renderPersonalCalendar();
            renderGeneralCalendar();
            renderEmployeeDashboard();
            
            showNotification('–î–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
        }

        function deleteEmployee(employeeId) {
            const employee = employees[employeeId];
            if (!employee) return;
            
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ "${employee.name}"? –í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.`)) {
                return;
            }
            
            // –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            delete employees[employeeId];
            delete schedules[employeeId];
            
            // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            Object.keys(tasks).forEach(key => {
                if (key.startsWith(employeeId + ':')) {
                    delete tasks[key];
                }
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            if (currentEmployeeId === employeeId) {
                const remainingIds = Object.keys(employees);
                currentEmployeeId = remainingIds.length > 0 ? remainingIds[0] : null;
            }
            
            scheduleAutoSave();
            updateEmployeeUI();
            updateTaskSelect();
            renderPersonalCalendar();
            renderGeneralCalendar();
            renderEmployeeDashboard();
            
            showNotification(`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ "${employee.name}" —É–¥–∞–ª–µ–Ω`, 'success');
        }

        // ==================== –ö–ê–õ–ï–ù–î–ê–†–¨ ====================
        function getMonthDays(year, month) {
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // –ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏ (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫)
            const startDay = new Date(firstDay);
            const dayOfWeek = startDay.getDay();
            const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            startDay.setDate(startDay.getDate() - diff);
            
            return { firstDay, lastDay, startDay };
        }

        function renderPersonalCalendar() {
            if (!currentEmployeeId) {
                document.getElementById('personalDays').innerHTML = `
                    <div class="text-center" style="grid-column: 1/-1; padding: 40px; color: var(--text-muted);">
                        <i class="fas fa-user-slash" style="font-size: 3rem; margin-bottom: 16px; opacity: 0.5;"></i>
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥—Ä–∞—Ñ–∏–∫–∞</p>
                    </div>
                `;
                updatePersonalTotals(0, 0, 0);
                return;
            }

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const { firstDay, lastDay, startDay } = getMonthDays(year, month);
            const employee = employees[currentEmployeeId];
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞
            const monthYear = currentDate.toLocaleString('ru-RU', { 
                month: 'long', 
                year: 'numeric' 
            }).replace(/^\w/, c => c.toUpperCase());
            
            document.getElementById('personalMonthYear').textContent = monthYear;
            
            // –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            const container = document.getElementById('personalDays');
            container.innerHTML = '';
            
            // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            const employeeSchedule = schedules[currentEmployeeId] || {};
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            let workedDays = 0;
            let totalHours = 0;
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–Ω–µ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—è
            const today = new Date();
            const todayStr = formatDate(today);
            
            for (let i = 0; i < 42; i++) {
                const currentDay = new Date(startDay);
                currentDay.setDate(startDay.getDate() + i);
                const dateStr = formatDate(currentDay);
                const isToday = dateStr === todayStr;
                const isCurrentMonth = currentDay.getMonth() === month;
                
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day';
                dayDiv.dataset.date = dateStr;
                
                if (!isCurrentMonth) {
                    dayDiv.classList.add('other-month');
                }
                
                if (isToday) {
                    dayDiv.classList.add('today');
                }
                
                // –ù–æ–º–µ—Ä –¥–Ω—è
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = currentDay.getDate();
                dayDiv.appendChild(dayNumber);
                
                // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–º–µ–Ω–µ
                const shiftEntry = employeeSchedule[dateStr];
                if (shiftEntry && isCurrentMonth) {
                    workedDays++;
                    totalHours += shiftEntry.hours;
                    
                    const shiftType = SHIFT_TYPES[shiftEntry.type.toUpperCase()];
                    const shiftDiv = document.createElement('div');
                    shiftDiv.className = `shift-info shift-${shiftEntry.type}`;
                    shiftDiv.innerHTML = `
                        ${shiftType.name}<br>
                        <strong>${shiftEntry.hours} —á</strong>
                    `;
                    dayDiv.appendChild(shiftDiv);
                    
                    if (shiftEntry.notes) {
                        const notesDiv = document.createElement('div');
                        notesDiv.className = 'task-report';
                        notesDiv.textContent = shiftEntry.notes;
                        dayDiv.appendChild(notesDiv);
                    }
                }
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
                dayDiv.addEventListener('click', () => {
                    if (!isCurrentMonth) return;
                    openShiftEditor(dateStr, shiftEntry);
                });
                
                container.appendChild(dayDiv);
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            const totalSalary = Math.round(totalHours * employee.rate);
            updatePersonalTotals(workedDays, totalHours, totalSalary);
        }

        function openShiftEditor(dateStr, existingEntry = null) {
            const date = parseDateString(dateStr);
            const formattedDate = date.toLocaleDateString('ru-RU', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            let shiftType = existingEntry ? existingEntry.type : 'day';
            let shiftHours = existingEntry ? existingEntry.hours : 12;
            let shiftNotes = existingEntry ? existingEntry.notes : '';
            
            const modalHtml = `
                <div class="modal" id="shiftEditorModal" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">
                                <i class="fas fa-user-clock"></i>
                                –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–º–µ–Ω—ã –Ω–∞ ${formattedDate}
                            </h2>
                            <button class="close-modal" onclick="document.getElementById('shiftEditorModal').remove()">√ó</button>
                        </div>
                        
                        <div class="modal-section">
                            <div class="form-group">
                                <label class="form-label">–¢–∏–ø —Å–º–µ–Ω—ã</label>
                                <div class="d-flex gap-10">
                                    <button class="btn ${shiftType === 'day' ? 'btn-success' : 'btn-outline'}" 
                                            onclick="selectShiftType('day')" style="flex: 1;">
                                        <i class="fas fa-sun"></i> –î–Ω–µ–≤–Ω–∞—è (12 —á)
                                    </button>
                                    <button class="btn ${shiftType === 'night' ? 'btn-danger' : 'btn-outline'}" 
                                            onclick="selectShiftType('night')" style="flex: 1;">
                                        <i class="fas fa-moon"></i> –ù–æ—á–Ω–∞—è (12 —á)
                                    </button>
                                    <button class="btn ${shiftType === 'custom' ? 'btn-warning' : 'btn-outline'}" 
                                            onclick="selectShiftType('custom')" style="flex: 1;">
                                        <i class="fas fa-user-clock"></i> –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ
                                    </button>
                                </div>
                            </div>
                            
                            <div class="form-group" id="customHoursGroup" ${shiftType !== 'custom' ? 'style="display:none;"' : ''}>
                                <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤</label>
                                <input type="number" id="shiftHours" class="form-control" 
                                       value="${shiftHours}" min="0.5" max="24" step="0.5">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                                <textarea id="shiftNotes" class="form-control" rows="3" 
                                          placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–º–µ–Ω–µ...">${shiftNotes}</textarea>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-10 justify-between">
                            <button class="btn btn-danger" onclick="deleteShift('${dateStr}')">
                                <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å —Å–º–µ–Ω—É
                            </button>
                            <div class="d-flex gap-10">
                                <button class="btn btn-outline" onclick="document.getElementById('shiftEditorModal').remove()">
                                    –û—Ç–º–µ–Ω–∞
                                </button>
                                <button class="btn btn-success" onclick="saveShift('${dateStr}')">
                                    <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            window.selectShiftType = function(type) {
                shiftType = type;
                document.querySelectorAll('#shiftEditorModal .btn').forEach(btn => {
                    btn.className = btn.className.replace('btn-success btn-danger btn-warning', 'btn-outline');
                });
                
                const buttons = document.querySelectorAll('#shiftEditorModal .btn');
                if (type === 'day') buttons[0].className = buttons[0].className.replace('btn-outline', 'btn-success');
                if (type === 'night') buttons[1].className = buttons[1].className.replace('btn-outline', 'btn-danger');
                if (type === 'custom') buttons[2].className = buttons[2].className.replace('btn-outline', 'btn-warning');
                
                const customHoursGroup = document.getElementById('customHoursGroup');
                customHoursGroup.style.display = type === 'custom' ? 'block' : 'none';
                
                if (type !== 'custom') {
                    shiftHours = SHIFT_TYPES[type.toUpperCase()].hours;
                    document.getElementById('shiftHours').value = shiftHours;
                }
            };
            
            window.saveShift = function(dateStr) {
                const hoursInput = document.getElementById('shiftHours');
                const notesInput = document.getElementById('shiftNotes');
                
                shiftHours = parseFloat(hoursInput.value) || 12;
                shiftNotes = notesInput.value.trim();
                
                if (shiftHours <= 0) {
                    delete schedules[currentEmployeeId][dateStr];
                } else {
                    if (!schedules[currentEmployeeId]) {
                        schedules[currentEmployeeId] = {};
                    }
                    
                    schedules[currentEmployeeId][dateStr] = {
                        hours: shiftHours,
                        type: shiftType,
                        notes: shiftNotes,
                        updatedAt: Date.now()
                    };
                }
                
                scheduleAutoSave();
                renderPersonalCalendar();
                renderGeneralCalendar();
                renderEmployeeDashboard();
                
                document.getElementById('shiftEditorModal').remove();
                showNotification('–°–º–µ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success');
            };
            
            window.deleteShift = function(dateStr) {
                if (confirm('–£–¥–∞–ª–∏—Ç—å —Å–º–µ–Ω—É?')) {
                    if (schedules[currentEmployeeId]) {
                        delete schedules[currentEmployeeId][dateStr];
                    }
                    
                    scheduleAutoSave();
                    renderPersonalCalendar();
                    renderGeneralCalendar();
                    renderEmployeeDashboard();
                    
                    document.getElementById('shiftEditorModal').remove();
                    showNotification('–°–º–µ–Ω–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
                }
            };
        }

        function updatePersonalTotals(days, hours, salary) {
            document.getElementById('personalWorkedDays').textContent = days;
            document.getElementById('personalTotalHours').textContent = hours.toFixed(1);
            document.getElementById('personalTotalSalary').textContent = formatCurrency(salary);
        }

        function renderGeneralCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const { firstDay, lastDay, startDay } = getMonthDays(year, month);
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞
            const monthYear = currentDate.toLocaleString('ru-RU', { 
                month: 'long', 
                year: 'numeric' 
            }).replace(/^\w/, c => c.toUpperCase());
            
            document.getElementById('generalMonthYear').textContent = monthYear;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
            const colorsDiv = document.getElementById('employeeColors');
            colorsDiv.innerHTML = '';
            
            Object.values(employees).sort((a, b) => a.name.localeCompare(b.name)).forEach(employee => {
                const colorItem = document.createElement('div');
                colorItem.className = 'color-item';
                colorItem.innerHTML = `
                    <div class="color-box" style="background:${employee.color}"></div>
                    <span>${employee.name}</span>
                `;
                colorsDiv.appendChild(colorItem);
            });
            
            // –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            const container = document.getElementById('generalDays');
            container.innerHTML = '';
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–Ω–µ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—è
            const today = new Date();
            const todayStr = formatDate(today);
            
            for (let i = 0; i < 42; i++) {
                const currentDay = new Date(startDay);
                currentDay.setDate(startDay.getDate() + i);
                const dateStr = formatDate(currentDay);
                const isCurrentMonth = currentDay.getMonth() === month;
                const isToday = dateStr === todayStr;
                
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day';
                dayDiv.dataset.date = dateStr;
                
                if (!isCurrentMonth) {
                    dayDiv.classList.add('other-month');
                }
                
                if (isToday) {
                    dayDiv.classList.add('today');
                }
                
                // –ù–æ–º–µ—Ä –¥–Ω—è
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = currentDay.getDate();
                dayDiv.appendChild(dayNumber);
                
                // –°–º–µ–Ω—ã –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                Object.values(employees).forEach(employee => {
                    const employeeSchedule = schedules[employee.id] || {};
                    const shiftEntry = employeeSchedule[dateStr];
                    
                    if (shiftEntry && isCurrentMonth) {
                        const shiftType = SHIFT_TYPES[shiftEntry.type.toUpperCase()];
                        const shiftDiv = document.createElement('div');
                        shiftDiv.className = 'shift-employee';
                        shiftDiv.style.backgroundColor = shiftType.color;
                        shiftDiv.title = `${employee.name}: ${shiftType.name}, ${shiftEntry.hours} —á`;
                        shiftDiv.innerHTML = `
                            <i class="${shiftType.icon}" style="font-size: 0.6rem; margin-right: 3px;"></i>
                            ${employee.name.split(' ')[0]}: ${shiftEntry.hours}—á
                        `;
                        dayDiv.appendChild(shiftDiv);
                    }
                });
                
                // –ó–∞–¥–∞—á–∏ –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                Object.values(employees).forEach(employee => {
                    const taskKey = `${employee.id}:${dateStr}`;
                    const taskList = tasks[taskKey] || [];
                    
                    taskList.forEach(task => {
                        if (task.completed || task.report) {
                            const taskDiv = document.createElement('div');
                            taskDiv.className = 'task-in-day';
                            taskDiv.title = `${employee.name}: ${task.text}`;
                            taskDiv.innerHTML = `
                                <strong>${employee.name.split(' ')[0]}:</strong> 
                                ${task.text.substring(0, 20)}${task.text.length > 20 ? '...' : ''}
                                ${task.report ? '<div class="task-report">' + task.report.substring(0, 30) + '...</div>' : ''}
                            `;
                            dayDiv.appendChild(taskDiv);
                        }
                    });
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π
                dayDiv.addEventListener('click', () => {
                    if (!isCurrentMonth) return;
                    showDayDetail(dateStr);
                });
                
                container.appendChild(dayDiv);
            }
        }

        function renderEmployeeDashboard() {
            const dashboard = document.getElementById('employeeDashboard');
            dashboard.innerHTML = '';
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            Object.values(employees).sort((a, b) => a.name.localeCompare(b.name)).forEach(employee => {
                const employeeSchedule = schedules[employee.id] || {};
                
                let workedDays = 0;
                let totalHours = 0;
                let dayHours = 0;
                let nightHours = 0;
                let customHours = 0;
                
                // –†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞ –º–µ—Å—è—Ü
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const shiftEntry = employeeSchedule[dateStr];
                    
                    if (shiftEntry) {
                        workedDays++;
                        totalHours += shiftEntry.hours;
                        
                        if (shiftEntry.type === 'day') dayHours += shiftEntry.hours;
                        else if (shiftEntry.type === 'night') nightHours += shiftEntry.hours;
                        else if (shiftEntry.type === 'custom') customHours += shiftEntry.hours;
                    }
                }
                
                const totalSalary = Math.round(totalHours * employee.rate);
                
                const card = document.createElement('div');
                card.className = 'employee-dash-card';
                card.innerHTML = `
                    <div class="employee-dash-name">${employee.name}</div>
                    <div class="employee-dash-stat">
                        <span>–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–Ω–µ–π:</span>
                        <span>${workedDays}</span>
                    </div>
                    <div class="employee-dash-stat">
                        <span>–í—Å–µ–≥–æ —á–∞—Å–æ–≤:</span>
                        <span>${totalHours.toFixed(1)}</span>
                    </div>
                    <div class="employee-dash-stat">
                        <span>–î–Ω–µ–≤–Ω—ã–µ:</span>
                        <span>${dayHours.toFixed(1)} —á</span>
                    </div>
                    <div class="employee-dash-stat">
                        <span>–ù–æ—á–Ω—ã–µ:</span>
                        <span>${nightHours.toFixed(1)} —á</span>
                    </div>
                    ${customHours > 0 ? `
                    <div class="employee-dash-stat">
                        <span>–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ:</span>
                        <span>${customHours.toFixed(1)} —á</span>
                    </div>
                    ` : ''}
                    <div class="employee-dash-salary">${formatCurrency(totalSalary)}</div>
                `;
                
                dashboard.appendChild(card);
            });
        }

        // ==================== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–ï–¢–ê–õ–ï–ô ====================
        function showDayDetail(dateStr) {
            const date = parseDateString(dateStr);
            const formattedDate = date.toLocaleDateString('ru-RU', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            document.getElementById('modalDateTitle').textContent = formattedDate;
            
            // –û—á–∏—Å—Ç–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
            document.getElementById('modalShifts').innerHTML = '';
            document.getElementById('modalTasks').innerHTML = '';
            document.getElementById('modalStats').innerHTML = '';
            
            // –°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            let totalEmployees = 0;
            let totalHours = 0;
            let totalTasks = 0;
            let completedTasks = 0;
            
            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–º–µ–Ω
            Object.values(employees).forEach(employee => {
                const employeeSchedule = schedules[employee.id] || {};
                const shiftEntry = employeeSchedule[dateStr];
                
                if (shiftEntry) {
                    totalEmployees++;
                    totalHours += shiftEntry.hours;
                    
                    const shiftItem = document.createElement('div');
                    shiftItem.className = 'shift-item';
                    
                    const shiftType = SHIFT_TYPES[shiftEntry.type.toUpperCase()];
                    shiftItem.innerHTML = `
                        <div class="d-flex justify-between align-center">
                            <div>
                                <strong style="color:${employee.color}">${employee.name}</strong>
                                <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 4px;">
                                    <i class="${shiftType.icon}"></i> ${shiftType.name} ‚Ä¢ ${shiftEntry.hours} —á–∞—Å–æ–≤
                                </div>
                                ${shiftEntry.notes ? `
                                <div style="font-size: 0.85rem; margin-top: 6px; padding: 8px; background: rgba(0,0,0,0.1); border-radius: 6px;">
                                    ${shiftEntry.notes}
                                </div>
                                ` : ''}
                            </div>
                            <span class="badge badge-${shiftEntry.type}">${shiftEntry.hours} —á</span>
                        </div>
                    `;
                    
                    document.getElementById('modalShifts').appendChild(shiftItem);
                }
            });
            
            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–¥–∞—á
            Object.values(employees).forEach(employee => {
                const taskKey = `${employee.id}:${dateStr}`;
                const taskList = tasks[taskKey] || [];
                
                taskList.forEach(task => {
                    totalTasks++;
                    if (task.completed || task.report) completedTasks++;
                    
                    const taskItem = document.createElement('div');
                    taskItem.className = 'task-item-modal';
                    taskItem.innerHTML = `
                        <div class="d-flex justify-between align-center">
                            <div style="color:${employee.color}; font-weight: 600;">
                                ${employee.name}
                            </div>
                            ${task.completed ? 
                                '<span class="badge badge-success"><i class="fas fa-check"></i> –í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>' : 
                                '<span class="badge badge-secondary"><i class="fas fa-clock"></i> –í —Ä–∞–±–æ—Ç–µ</span>'
                            }
                        </div>
                        <div style="margin-top: 8px; font-weight: 500;">${task.text}</div>
                        ${task.report ? `
                        <div style="margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.1); border-radius: 6px; font-size: 0.9rem;">
                            <strong>–û—Ç—á—ë—Ç:</strong> ${task.report}
                        </div>
                        ` : ''}
                        <div style="margin-top: 8px; font-size: 0.8rem; color: var(--text-muted);">
                            <i class="fas fa-calendar"></i> –°–æ–∑–¥–∞–Ω–æ: ${new Date(task.createdAt).toLocaleDateString('ru-RU')}
                            ${task.updatedAt !== task.createdAt ? 
                                `<br><i class="fas fa-edit"></i> –û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(task.updatedAt).toLocaleDateString('ru-RU')}` : 
                                ''
                            }
                        </div>
                    `;
                    
                    document.getElementById('modalTasks').appendChild(taskItem);
                });
            });
            
            // –ï—Å–ª–∏ –Ω–µ—Ç —Å–º–µ–Ω
            if (document.getElementById('modalShifts').children.length === 0) {
                document.getElementById('modalShifts').innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-user-clock" style="font-size: 2rem; margin-bottom: 12px;"></i>
                        <p>–ù–µ—Ç —Å–º–µ–Ω –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å</p>
                    </div>
                `;
            }
            
            // –ï—Å–ª–∏ –Ω–µ—Ç –∑–∞–¥–∞—á
            if (document.getElementById('modalTasks').children.length === 0) {
                document.getElementById('modalTasks').innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-tasks" style="font-size: 2rem; margin-bottom: 12px;"></i>
                        <p>–ù–µ—Ç –∑–∞–¥–∞—á –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å</p>
                    </div>
                `;
            }
            
            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            const statsDiv = document.getElementById('modalStats');
            statsDiv.innerHTML = `
                <div class="d-flex gap-20 justify-center" style="flex-wrap: wrap;">
                    <div class="total-card" style="min-width: 150px;">
                        <div class="total-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–∞ —Å–º–µ–Ω–µ</div>
                        <div class="big-number">${totalEmployees}</div>
                    </div>
                    <div class="total-card" style="min-width: 150px;">
                        <div class="total-label">–í—Å–µ–≥–æ —á–∞—Å–æ–≤</div>
                        <div class="big-number">${totalHours.toFixed(1)}</div>
                    </div>
                    <div class="total-card" style="min-width: 150px;">
                        <div class="total-label">–ó–∞–¥–∞—á</div>
                        <div class="big-number">${totalTasks}</div>
                        <div class="total-label-small">${completedTasks} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                    </div>
                </div>
            `;
            
            // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            document.getElementById('dayModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('dayModal').style.display = 'none';
        }

        // ==================== –ó–ê–î–ê–ß–ò ====================
        function updateTaskSelect() {
            const select = document.getElementById('taskEmployee');
            select.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ‚Äî</option>';
            
            Object.values(employees).sort((a, b) => a.name.localeCompare(b.name)).forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = employee.name;
                select.appendChild(option);
            });
        }

        function addTask() {
            const employeeId = document.getElementById('taskEmployee').value;
            const date = document.getElementById('taskDate').value;
            const text = document.getElementById('newTaskText').value.trim();
            
            if (!employeeId || !date || !text) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            if (text.length < 3) {
                showNotification('–¢–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                return;
            }
            
            const taskKey = `${employeeId}:${date}`;
            if (!tasks[taskKey]) {
                tasks[taskKey] = [];
            }
            
            tasks[taskKey].push({
                text: text,
                report: '',
                completed: false,
                createdAt: Date.now(),
                updatedAt: Date.now()
            });
            
            scheduleAutoSave();
            renderTasks();
            renderGeneralCalendar();
            
            // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è –≤–≤–æ–¥–∞
            document.getElementById('newTaskText').value = '';
            document.getElementById('newTaskText').focus();
            
            showNotification('–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
        }

        function renderTasks() {
            const employeeId = document.getElementById('taskEmployee').value;
            const date = document.getElementById('taskDate').value;
            const list = document.getElementById('taskList');
            
            if (!employeeId || !date) {
                list.innerHTML = `
                    <div class="text-center" style="padding: 40px; color: var(--text-muted);">
                        <i class="fas fa-clipboard-list" style="font-size: 3rem; margin-bottom: 16px; opacity: 0.5;"></i>
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏ –¥–∞—Ç—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–¥–∞—á</p>
                    </div>
                `;
                return;
            }
            
            const taskKey = `${employeeId}:${date}`;
            const taskList = tasks[taskKey] || [];
            
            if (taskList.length === 0) {
                list.innerHTML = `
                    <div class="text-center" style="padding: 40px; color: var(--text-muted);">
                        <i class="fas fa-clipboard-list" style="font-size: 3rem; margin-bottom: 16px; opacity: 0.5;"></i>
                        <p>–ù–µ—Ç –∑–∞–¥–∞—á –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = '';
            
            taskList.forEach((task, index) => {
                const item = document.createElement('div');
                item.className = 'task-item';
                item.innerHTML = `
                    <div class="d-flex justify-between align-center">
                        <div class="task-text">${task.text}</div>
                        <div>
                            ${task.completed ? 
                                '<span class="badge badge-success"><i class="fas fa-check"></i> –í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>' : 
                                '<span class="badge badge-secondary"><i class="fas fa-clock"></i> –í —Ä–∞–±–æ—Ç–µ</span>'
                            }
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">–û—Ç—á—ë—Ç –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏</label>
                        <textarea class="task-report-input" 
                                  placeholder="–û–ø–∏—à–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏..." 
                                  oninput="updateTaskReport('${employeeId}', '${date}', ${index}, this.value)">${task.report}</textarea>
                    </div>
                    
                    <div class="d-flex justify-between align-center">
                        <div>
                            <button class="btn btn-sm ${task.completed ? 'btn-outline' : 'btn-success'}" 
                                    onclick="toggleTaskCompletion('${employeeId}', '${date}', ${index})">
                                <i class="fas ${task.completed ? 'fa-undo' : 'fa-check'}"></i>
                                ${task.completed ? '–í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å' : '–ó–∞–≤–µ—Ä—à–∏—Ç—å'}
                            </button>
                        </div>
                        <div class="task-actions">
                            <button class="btn btn-danger btn-sm" onclick="deleteTask('${employeeId}', '${date}', ${index})">
                                <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                    </div>
                    
                    <div style="font-size: 0.8rem; color: var(--text-muted);">
                        <i class="fas fa-calendar"></i> –°–æ–∑–¥–∞–Ω–æ: ${new Date(task.createdAt).toLocaleString('ru-RU')}
                        ${task.updatedAt !== task.createdAt ? 
                            `<br><i class="fas fa-edit"></i> –û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(task.updatedAt).toLocaleString('ru-RU')}` : 
                            ''
                        }
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function updateTaskReport(employeeId, date, index, report) {
            const taskKey = `${employeeId}:${date}`;
            if (tasks[taskKey] && tasks[taskKey][index]) {
                tasks[taskKey][index].report = report;
                tasks[taskKey][index].updatedAt = Date.now();
                scheduleAutoSave();
                renderGeneralCalendar();
            }
        }

        function toggleTaskCompletion(employeeId, date, index) {
            const taskKey = `${employeeId}:${date}`;
            if (tasks[taskKey] && tasks[taskKey][index]) {
                tasks[taskKey][index].completed = !tasks[taskKey][index].completed;
                tasks[taskKey][index].updatedAt = Date.now();
                scheduleAutoSave();
                renderTasks();
                renderGeneralCalendar();
                
                const status = tasks[taskKey][index].completed ? '–≤—ã–ø–æ–ª–Ω–µ–Ω–∞' : '–≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∞';
                showNotification(`–ó–∞–¥–∞—á–∞ ${status}`, 'success');
            }
        }

        function deleteTask(employeeId, date, index) {
            const taskKey = `${employeeId}:${date}`;
            if (tasks[taskKey] && tasks[taskKey][index]) {
                if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) return;
                
                tasks[taskKey].splice(index, 1);
                if (tasks[taskKey].length === 0) {
                    delete tasks[taskKey];
                }
                scheduleAutoSave();
                renderTasks();
                renderGeneralCalendar();
                showNotification('–ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
            }
        }

        // ==================== –ù–ê–í–ò–ì–ê–¶–ò–Ø ====================
        function prevMonth(general = false) {
            currentDate.setMonth(currentDate.getMonth() - 1);
            general ? renderGeneralCalendar() : renderPersonalCalendar();
            if (general) renderEmployeeDashboard();
        }

        function nextMonth(general = false) {
            currentDate.setMonth(currentDate.getMonth() + 1);
            general ? renderGeneralCalendar() : renderPersonalCalendar();
            if (general) renderEmployeeDashboard();
        }

        function goToToday(general = false) {
            currentDate = new Date();
            general ? renderGeneralCalendar() : renderPersonalCalendar();
            if (general) renderEmployeeDashboard();
            showNotification('–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ç–µ–∫—É—â–µ–º—É –º–µ—Å—è—Ü—É', 'info');
        }

        function openTab(tabId) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // –£–±—Ä–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.getElementById(tabId).classList.add('active');
            
            // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
            document.querySelector(`.tab-btn[onclick="openTab('${tabId}')"]`).classList.add('active');
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –≤–∫–ª–∞–¥–∫–∞—Ö
            if (tabId === 'general') {
                renderGeneralCalendar();
                renderEmployeeDashboard();
            } else if (tabId === 'tasks') {
                renderTasks();
            }
        }

        // ==================== –≠–ö–°–ü–û–†–¢/–ò–ú–ü–û–†–¢ ====================
        function exportData() {
            const data = {
                employees: employees,
                schedules: schedules,
                tasks: tasks,
                settings: settings,
                exportDate: new Date().toISOString(),
                version: '3.0'
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `workshift-manager-backup-${formatDate(new Date())}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ JSON', 'success');
        }

        function exportToCSV() {
            let csv = '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏\n';
            csv += 'ID,–§–ò–û,–°—Ç–∞–≤–∫–∞ (‚ÇΩ/—á),–¶–≤–µ—Ç\n';
            
            Object.values(employees).forEach(emp => {
                csv += `${emp.id},"${emp.name}",${emp.rate},"${emp.color}"\n`;
            });
            
            csv += '\n\n–°–º–µ–Ω—ã\n';
            csv += 'ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞,–î–∞—Ç–∞,–ß–∞—Å—ã,–¢–∏–ø,–ü—Ä–∏–º–µ—á–∞–Ω–∏—è\n';
            
            Object.keys(schedules).forEach(empId => {
                Object.keys(schedules[empId]).forEach(date => {
                    const shift = schedules[empId][date];
                    csv += `${empId},${date},${shift.hours},${shift.type},"${shift.notes || ''}"\n`;
                });
            });
            
            csv += '\n\n–ó–∞–¥–∞—á–∏\n';
            csv += '–ö–ª—é—á,–¢–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏,–û—Ç—á—ë—Ç,–í—ã–ø–æ–ª–Ω–µ–Ω–æ,–°–æ–∑–¥–∞–Ω–æ\n';
            
            Object.keys(tasks).forEach(key => {
                tasks[key].forEach(task => {
                    csv += `${key},"${task.text}","${task.report}",${task.completed},${new Date(task.createdAt).toISOString()}\n`;
                });
            });
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `workshift-data-${formatDate(new Date())}.csv`;
            link.click();
            
            showNotification('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ CSV', 'success');
        }

        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.employees || !data.schedules || !data.tasks) {
                        throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
                    }
                    
                    if (!confirm(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ.`)) {
                        return;
                    }
                    
                    employees = data.employees;
                    schedules = data.schedules;
                    tasks = data.tasks;
                    if (data.settings) settings = data.settings;
                    
                    scheduleAutoSave();
                    initializeUI();
                    
                    showNotification('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
                    fileInput.value = '';
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:', error);
                    showNotification('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.', 'error');
                }
            };
            
            reader.readAsText(file);
        }

        function createBackup() {
            const backup = {
                employees: employees,
                schedules: schedules,
                tasks: tasks,
                settings: settings,
                backupDate: new Date().toISOString()
            };
            
            localStorage.setItem(STORAGE_KEYS.BACKUP, JSON.stringify(backup));
            showNotification('–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞', 'success');
        }

        function restoreBackup() {
            const backupData = localStorage.getItem(STORAGE_KEYS.BACKUP);
            
            if (!backupData) {
                showNotification('–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                return;
            }
            
            if (!confirm('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏? –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
                return;
            }
            
            try {
                const backup = JSON.parse(backupData);
                employees = backup.employees;
                schedules = backup.schedules;
                tasks = backup.tasks;
                settings = backup.settings;
                
                scheduleAutoSave();
                initializeUI();
                
                showNotification('–î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏', 'success');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
                showNotification('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö', 'error');
            }
        }

        function clearAllData() {
            if (!confirm('–í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                return;
            }
            
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                return;
            }
            
            employees = {};
            schedules = {};
            tasks = {};
            settings = { ...DEFAULT_SETTINGS };
            currentEmployeeId = null;
            
            Object.values(STORAGE_KEYS).forEach(key => {
                localStorage.removeItem(key);
            });
            
            // –û—á–∏—â–∞–µ–º Firebase –µ—Å–ª–∏ –µ—Å—Ç—å
            if (db) {
                db.collection('users').doc(userId).delete().catch(() => {});
            }
            
            createDemoData();
            initializeUI();
            showNotification('–í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã', 'success');
        }
    </script>
</body>
</html>
